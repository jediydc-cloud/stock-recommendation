name: ì£¼ì‹ ë¶„ì„ ìë™ ì‹¤í–‰

on:
  schedule:
    # í‰ì¼ ì˜¤ì „ 8ì‹œ (í•œêµ­ì‹œê°„ ê¸°ì¤€, UTC 23:00 = í•œêµ­ì‹œê°„ 08:00)
    - cron: '0 23 * * 1-5'  # ì›”~ê¸ˆìš”ì¼ë§Œ ì‹¤í–‰
  
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ (ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥)

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # íƒ€ì„ì•„ì›ƒ í™•ëŒ€
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      
    - name: Python ì„¤ì¹˜
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      run: |
        echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œì‘..."
        pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
        
    - name: ì£¼ì‹ ë¶„ì„ ì‹¤í–‰
      id: analyze
      timeout-minutes: 100
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PYTHONUNBUFFERED: 1
      run: |
        echo "=========================================="
        echo "ğŸ” ë””ë²„ê¹… ì •ë³´"
        echo "=========================================="
        echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo ""
        echo "Python íŒŒì¼ ëª©ë¡:"
        ls -lh *.py
        echo ""
        echo "Python ë²„ì „:"
        python --version
        echo ""
        echo "ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€:"
        pip list | grep -E "pykrx|pandas|numpy|requests|pytz"
        echo ""
        echo "=========================================="
        echo "ğŸš€ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘"
        echo "=========================================="
        python -u stock_recommendation_with_exchange.py
      continue-on-error: false
        
    - name: ë¡œê·¸ íŒŒì¼ ì €ì¥ (ì—ëŸ¬ ë°œìƒ ì‹œ)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          *.log
          output/
        retention-days: 7
        
    - name: ë¶„ì„ ê²°ê³¼ ì—…ë¡œë“œ
      if: success()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./output
        publish_branch: gh-pages
        
    - name: ë¶„ì„ ì™„ë£Œ ì•Œë¦¼
      if: always()
      run: |
        if [ "${{ steps.analyze.outcome }}" == "success" ]; then
          echo "âœ… ì£¼ì‹ ë¶„ì„ ì„±ê³µ!"
          echo "ğŸ“Š ì›¹í˜ì´ì§€: https://jediydc-cloud.github.io/stock-recommendation/"
        else
          echo "âŒ ì£¼ì‹ ë¶„ì„ ì‹¤íŒ¨!"
          echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        fi
