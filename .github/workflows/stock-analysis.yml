name: Stock Analysis Auto Run

# ìŠ¤ì¼€ì¤„: ë§¤ì¼ í‰ì¼ ì˜¤ì „ 8ì‹œ (KST ê¸°ì¤€ì€ UTC-9, ì¦‰ ì „ë‚  23ì‹œ)
on:
  schedule:
    - cron: '0 23 * * 0-4'  # ì¼ìš”ì¼ 23:00 ~ ëª©ìš”ì¼ 23:00 UTC (ì›”~ê¸ˆ 08:00 KST)
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3
      
      # 2. Python í™˜ê²½ ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # 3. ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜ (lxml ì¶”ê°€ - pykrx í•„ìˆ˜ ì˜ì¡´ì„±)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install lxml pykrx pytz yfinance pandas matplotlib google-generativeai requests beautifulsoup4 Pillow
      
      # 4. í•œê¸€ í°íŠ¸ ì„¤ì¹˜ (ì°¨íŠ¸ ìƒì„±ìš©)
      - name: Install Korean fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-nanum fonts-nanum-coding
          fc-cache -fv
      
      # 5. Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (í™˜ê²½ë³€ìˆ˜ ì „ë‹¬)
      - name: Run stock analysis
        env:
          DART_API: ${{ secrets.DART_API }}
          swingTrading: ${{ secrets.swingTrading }}
        run: |
          python stock_swing_trading.py
      
      # 6. index.html ìƒì„± ë° ì´ì „ íŒŒì¼ ì •ë¦¬
      - name: Clean old HTML files and create index
        run: |
          if ls stock_result_*.html 1> /dev/null 2>&1; then
            echo "ğŸ“‚ í˜„ì¬ HTML íŒŒì¼ ëª©ë¡:"
            ls -lht stock_result_*.html
            
            # ìµœì‹  íŒŒì¼ ì°¾ê¸°
            LATEST=$(ls -t stock_result_*.html | head -n 1)
            echo "âœ… ìµœì‹  íŒŒì¼: $LATEST"
            
            # index.htmlë¡œ ë³µì‚¬ (GitHub Pages ë©”ì¸ í˜ì´ì§€)
            cp "$LATEST" index.html
            echo "ğŸ“ index.html ìƒì„± ì™„ë£Œ"
            
            # ìµœì‹  íŒŒì¼ 1ê°œë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ
            echo "ğŸ§¹ ì˜¤ë˜ëœ íŒŒì¼ ì‚­ì œ ì¤‘..."
            ls -t stock_result_*.html | tail -n +2 | xargs -r rm -v
            
            echo "âœ… ì •ë¦¬ ì™„ë£Œ! ìµœì‹  íŒŒì¼ + index.html:"
            ls -lh stock_result_*.html index.html
          else
            echo "âš ï¸ HTML íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
      
      # 7. ê²°ê³¼ íŒŒì¼ì„ ì €ì¥ì†Œì— ì»¤ë°‹
      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add *.html
          git add -u  # ì‚­ì œëœ íŒŒì¼ë„ ìŠ¤í…Œì´ì§•
          git diff --quiet && git diff --staged --quiet || git commit -m "Auto update: Stock analysis $(date +'%Y-%m-%d %H:%M:%S')"
          git push
