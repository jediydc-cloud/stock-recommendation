# -*- coding: utf-8 -*-
"""stock_recommendation_WITH_REFRESH.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1P26_Vsyc1AmpIkRBeNxWjBzJaBEpvs7t
"""

"""
ğŸ¤– êµ­ë‚´ ì£¼ì‹ AI ì¶”ì²œ ì‹œìŠ¤í…œ v3.1 - ìµœì¢… ì™„ì„±íŒ
- ì „ì²´ 2,700ê°œ ì¢…ëª© ë¶„ì„
- í‰ì¼ ì˜¤ì „ 8ì‹œ ìë™ ì—…ë°ì´íŠ¸
- ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥ (GitHub Actions íŠ¸ë¦¬ê±°)
"""

from datetime import datetime, timedelta
import pandas as pd
import numpy as np
import warnings
warnings.filterwarnings('ignore')

print("ğŸ”§ í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ ì¤‘...")

try:
    import FinanceDataReader as fdr
    from pykrx import stock
    print("âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ")
except ImportError:
    print("ğŸ“¥ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì¤‘...")
    import subprocess
    subprocess.run(["pip", "install", "-q", "finance-datareader", "pykrx"], check=False)
    import FinanceDataReader as fdr
    from pykrx import stock
    print("âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ë° ë¡œë“œ ì™„ë£Œ")

import time

# ========================================
# ğŸ“Š ì„¤ì •
# ========================================

SYSTEM_TITLE = "êµ­ë‚´ ì£¼ì‹ AI ì¶”ì²œ ì‹œìŠ¤í…œ (ì „ì²´ ì¢…ëª© ë¶„ì„)"
MAX_STOCKS_TO_SCAN = 999999  # ì „ì²´ ì¢…ëª© ìŠ¤ìº” (ë¬´ì œí•œ)
MIN_PRICE = 1000
TOP_N_STOCKS = 8
MAX_RSI = 40

# GitHub ì„¤ì • (ì‚¬ìš©ìê°€ ì„¤ì •í•´ì•¼ í•¨)
GITHUB_USERNAME = "jediydc-cloud"  # ì˜ˆ: "john-doe"
GITHUB_REPO = "stock-recommendation"  # ì˜ˆ: "stock-recommendation"
GITHUB_TOKEN = "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"  # ë‚˜ì¤‘ì— ì„¤ëª…

# ========================================
# ğŸ“ˆ ë°ì´í„° ìˆ˜ì§‘ í´ë˜ìŠ¤ (ë™ì¼)
# ========================================

class StockAnalyzer:
    """ì‹¤ì‹œê°„ ì£¼ì‹ ë¶„ì„ê¸°"""

    def __init__(self):
        self.today = datetime.now()
        self.today_str = self.today.strftime('%Y%m%d')
        print(f"\nğŸ“… ë¶„ì„ ê¸°ì¤€ì¼: {self.today.strftime('%Yë…„ %mì›” %dì¼')}")

    def get_all_stocks(self):
        """ì „ì²´ ìƒì¥ ì¢…ëª©"""
        try:
            kospi = fdr.StockListing('KOSPI')
            kosdaq = fdr.StockListing('KOSDAQ')
            all_stocks = pd.concat([kospi, kosdaq], ignore_index=True)

            if 'Market' not in all_stocks.columns:
                all_stocks['Market'] = all_stocks['Code'].apply(
                    lambda x: 'KOSPI' if x in kospi['Code'].values else 'KOSDAQ'
                )
            if 'Sector' not in all_stocks.columns:
                all_stocks['Sector'] = 'ê¸°íƒ€'

            return all_stocks
        except:
            return None

    def calculate_rsi(self, prices, period=14):
        """RSI ê³„ì‚°"""
        try:
            delta = prices.diff()
            gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
            loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
            rs = gain / loss
            rsi = 100 - (100 / (1 + rs))
            return rsi.iloc[-1]
        except:
            return None

    def get_stock_data(self, code, name):
        """ê°œë³„ ì¢…ëª© ë°ì´í„°"""
        try:
            end_date = self.today
            start_date = end_date - timedelta(days=90)
            df = fdr.DataReader(code, start_date, end_date)

            if df is None or len(df) < 20:
                return None

            current_price = df['Close'].iloc[-1]
            prev_close = df['Close'].iloc[-2] if len(df) > 1 else current_price
            change_pct = ((current_price - prev_close) / prev_close) * 100

            rsi = self.calculate_rsi(df['Close'])
            if rsi is None or rsi > MAX_RSI:
                return None

            ma5 = df['Close'].rolling(window=5).mean().iloc[-1]
            ma20 = df['Close'].rolling(window=20).mean().iloc[-1]
            disparity_20 = (current_price / ma20) * 100

            avg_volume = df['Volume'].tail(20).mean()
            current_volume = df['Volume'].iloc[-1]
            volume_ratio = (current_volume / avg_volume) * 100 if avg_volume > 0 else 0

            typical_price = (df['High'].iloc[-1] + df['Low'].iloc[-1] + df['Close'].iloc[-1]) / 3
            vwap = typical_price
            vwap_diff = ((current_price - vwap) / vwap) * 100

            golden_cross = ma5 > ma20 and df['Close'].rolling(5).mean().iloc[-2] <= df['Close'].rolling(20).mean().iloc[-2]

            return {
                'code': code,
                'name': name,
                'current_price': int(current_price),
                'change_pct': round(change_pct, 2),
                'rsi': round(rsi, 1),
                'disparity_20': round(disparity_20, 1),
                'volume_ratio': round(volume_ratio, 1),
                'vwap_diff': round(vwap_diff, 2),
                'ma5': int(ma5),
                'ma20': int(ma20),
                'golden_cross': golden_cross
            }
        except:
            return None

    def get_fundamental_data(self, code):
        """ì¬ë¬´ ë°ì´í„°"""
        try:
            df = stock.get_market_fundamental(self.today_str, self.today_str, code)
            if df.empty:
                return None

            per = df['PER'].iloc[0]
            pbr = df['PBR'].iloc[0]

            return {
                'per': round(per, 2) if per > 0 else 0,
                'pbr': round(pbr, 2) if pbr > 0 else 0
            }
        except:
            return None

    def calculate_risk_level(self, tech_data, fund_data):
        """ìœ„í—˜ë„ ê³„ì‚°"""
        risk_score = 0

        if tech_data['rsi'] < 20:
            risk_score += 1
        elif tech_data['rsi'] < 30:
            risk_score += 2
        else:
            risk_score += 3

        if tech_data['volume_ratio'] > 200:
            risk_score += 1
        elif tech_data['volume_ratio'] > 150:
            risk_score += 2
        else:
            risk_score += 3

        if fund_data and fund_data['pbr'] > 0:
            if fund_data['pbr'] < 0.3:
                risk_score += 1
            elif fund_data['pbr'] < 0.5:
                risk_score += 2
            else:
                risk_score += 3
        else:
            risk_score += 2

        avg_risk = risk_score / 3
        if avg_risk <= 1.5:
            return "ì €"
        elif avg_risk <= 2.5:
            return "ì¤‘"
        else:
            return "ê³ "

    def calculate_score(self, tech_data, fund_data):
        """ì ìˆ˜ ê³„ì‚°"""
        score = 0
        reasons = []

        if tech_data['rsi'] < 25:
            score += 30
            reasons.append(f"RSI {tech_data['rsi']} ê·¹ì‹¬í•œ ê³¼ë§¤ë„")
        elif tech_data['rsi'] < 30:
            score += 25
            reasons.append(f"RSI {tech_data['rsi']} ê³¼ë§¤ë„")
        elif tech_data['rsi'] < 35:
            score += 15
            reasons.append(f"RSI {tech_data['rsi']} ê³¼ë§¤ë„ ì§„ì…")

        if tech_data['disparity_20'] < 90:
            score += 20
            reasons.append(f"20ì¼ì„  ì´ê²©ë„ {tech_data['disparity_20']}%")
        elif tech_data['disparity_20'] < 95:
            score += 15
            reasons.append(f"ì´ê²©ë„ {tech_data['disparity_20']}%")

        if tech_data['volume_ratio'] > 200:
            score += 20
            reasons.append(f"ê±°ë˜ëŸ‰ {int(tech_data['volume_ratio'])}% ê¸‰ì¦")
        elif tech_data['volume_ratio'] > 150:
            score += 15
            reasons.append(f"ê±°ë˜ëŸ‰ ì¦ê°€ {int(tech_data['volume_ratio'])}%")

        if -5 < tech_data['vwap_diff'] < 0:
            score += 15
            reasons.append("VWAP ì§€ì§€ì„  ê·¼ì ‘")

        if fund_data and fund_data['pbr'] > 0:
            if fund_data['pbr'] < 0.3:
                score += 15
                reasons.append(f"PBR {fund_data['pbr']}ë°° ê·¹ì €í‰ê°€")
            elif fund_data['pbr'] < 0.5:
                score += 12
                reasons.append(f"PBR {fund_data['pbr']}ë°° ì €í‰ê°€")

        return score, reasons

    def scan_stocks(self):
        """ì „ì²´ ì¢…ëª© ìŠ¤ìº”"""
        print("\n" + "="*70)
        print("ğŸ” ì‹¤ì‹œê°„ ì¢…ëª© ìŠ¤ìº” ì‹œì‘")
        print("="*70)

        all_stocks = self.get_all_stocks()
        if all_stocks is None:
            return [], [], [], {}

        print(f"âœ… ì´ {len(all_stocks)}ê°œ ì¢…ëª© ìˆ˜ì§‘")

        candidates = []
        golden_cross_stocks = []
        high_volume_stocks = []
        sector_analysis = {}

        scan_count = 0
        max_scan = min(MAX_STOCKS_TO_SCAN, len(all_stocks))

        print(f"ğŸ“Š {max_scan}ê°œ ì¢…ëª© ë¶„ì„ ì¤‘...\n")
        start_time = time.time()

        for idx, row in all_stocks.iterrows():
            if scan_count >= max_scan:
                break

            code = row['Code']
            name = row['Name']
            sector = row.get('Sector', 'ê¸°íƒ€')

            if scan_count % 50 == 0 and scan_count > 0:
                elapsed = time.time() - start_time
                speed = scan_count / elapsed
                remaining = (max_scan - scan_count) / speed if speed > 0 else 0
                print(f"ğŸ“ˆ ì§„í–‰: {scan_count}/{max_scan} ({scan_count/max_scan*100:.0f}%) | "
                      f"í›„ë³´: {len(candidates)}ê°œ | ì˜ˆìƒ: {int(remaining)}ì´ˆ")

            scan_count += 1

            tech_data = self.get_stock_data(code, name)
            if tech_data is None:
                continue

            if tech_data['current_price'] < MIN_PRICE:
                continue

            fund_data = self.get_fundamental_data(code)
            score, reasons = self.calculate_score(tech_data, fund_data)

            if sector not in sector_analysis:
                sector_analysis[sector] = {'count': 0, 'avg_rsi': [], 'rising': 0}
            sector_analysis[sector]['count'] += 1
            sector_analysis[sector]['avg_rsi'].append(tech_data['rsi'])
            if tech_data['change_pct'] > 0:
                sector_analysis[sector]['rising'] += 1

            if tech_data.get('golden_cross'):
                golden_cross_stocks.append({
                    'name': name,
                    'code': code,
                    'price': tech_data['current_price'],
                    'change': tech_data['change_pct']
                })

            if tech_data['volume_ratio'] > 200:
                high_volume_stocks.append({
                    'name': name,
                    'code': code,
                    'volume_ratio': tech_data['volume_ratio'],
                    'price': tech_data['current_price']
                })

            if score < 30:
                continue

            risk_level = self.calculate_risk_level(tech_data, fund_data)

            candidates.append({
                'score': score,
                'tech': tech_data,
                'fund': fund_data,
                'reasons': reasons,
                'sector': sector,
                'market': row.get('Market', 'ì•Œìˆ˜ì—†ìŒ'),
                'risk_level': risk_level
            })

            time.sleep(0.05)

        elapsed = time.time() - start_time
        print(f"\nâœ… ìŠ¤ìº” ì™„ë£Œ: {scan_count}ê°œ ë¶„ì„ ({int(elapsed)}ì´ˆ)")
        print(f"   - ì¶”ì²œ í›„ë³´: {len(candidates)}ê°œ")
        print(f"   - ê³¨ë“ í¬ë¡œìŠ¤: {len(golden_cross_stocks)}ê°œ")
        print(f"   - ê±°ë˜ëŸ‰ ê¸‰ì¦: {len(high_volume_stocks)}ê°œ")

        candidates.sort(key=lambda x: x['score'], reverse=True)
        golden_cross_stocks.sort(key=lambda x: x['change'], reverse=True)
        high_volume_stocks.sort(key=lambda x: x['volume_ratio'], reverse=True)

        return candidates[:TOP_N_STOCKS], golden_cross_stocks[:10], high_volume_stocks[:10], sector_analysis


def get_market_overview():
    """ì‹œì¥ ê°œìš”"""
    try:
        kospi_df = fdr.DataReader('KS11', datetime.now() - timedelta(days=30), datetime.now())
        kosdaq_df = fdr.DataReader('KQ11', datetime.now() - timedelta(days=30), datetime.now())

        kospi_value = kospi_df['Close'].iloc[-1]
        kospi_prev = kospi_df['Close'].iloc[-2]
        kospi_change = ((kospi_value - kospi_prev) / kospi_prev) * 100

        kosdaq_value = kosdaq_df['Close'].iloc[-1]
        kosdaq_prev = kosdaq_df['Close'].iloc[-2]
        kosdaq_change = ((kosdaq_value - kosdaq_prev) / kosdaq_prev) * 100

        def calc_rsi(prices):
            delta = prices.diff()
            gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
            loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
            rs = gain / loss
            return 100 - (100 / (1 + rs)).iloc[-1]

        kospi_rsi = calc_rsi(kospi_df['Close'])
        kosdaq_rsi = calc_rsi(kosdaq_df['Close'])

        if kospi_rsi < 30:
            sentiment = "ì¡°ì • êµ­ë©´ (ë°˜ë“± ê¸°íšŒ)"
        elif kospi_rsi < 40:
            sentiment = "ì•½ì„¸ì¥ (ì €ì  ì ‘ê·¼)"
        else:
            sentiment = "ì¤‘ë¦½"

        return {
            'kospi': {'value': round(kospi_value, 2), 'change': round(kospi_change, 2), 'rsi': round(kospi_rsi, 1)},
            'kosdaq': {'value': round(kosdaq_value, 2), 'change': round(kosdaq_change, 2), 'rsi': round(kosdaq_rsi, 1)},
            'sentiment': sentiment
        }
    except:
        return {
            'kospi': {'value': 0, 'change': 0, 'rsi': 50},
            'kosdaq': {'value': 0, 'change': 0, 'rsi': 50},
            'sentiment': 'ë¶„ì„ ì¤‘'
        }


def generate_html(top8, golden_cross, high_volume, sector_analysis, market_data):
    """HTML ìƒì„± - ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í¬í•¨"""

    update_time = datetime.now().strftime('%Yë…„ %mì›” %dì¼ %H:%M')
    weekday = datetime.now().strftime('%A')
    weekday_kr = {'Monday': 'ì›”', 'Tuesday': 'í™”', 'Wednesday': 'ìˆ˜',
                  'Thursday': 'ëª©', 'Friday': 'ê¸ˆ', 'Saturday': 'í† ', 'Sunday': 'ì¼'}

    # ì—…ì¢… ë¶„ì„ HTML
    sector_html = ""
    sorted_sectors = sorted(
        [(k, v) for k, v in sector_analysis.items() if v['count'] > 0],
        key=lambda x: sum(x[1]['avg_rsi']) / len(x[1]['avg_rsi']) if x[1]['avg_rsi'] else 50
    )[:5]

    for sector, data in sorted_sectors:
        avg_rsi = sum(data['avg_rsi']) / len(data['avg_rsi']) if data['avg_rsi'] else 50
        rising_pct = (data['rising'] / data['count'] * 100) if data['count'] > 0 else 0
        status = "ğŸ”´ ì•½ì„¸" if avg_rsi < 35 else "ğŸŸ¢ ê°•ì„¸" if avg_rsi > 60 else "âšª ì¤‘ë¦½"

        sector_html += f"""
            <div class="sector-item">
                <div class="sector-name">{sector}</div>
                <div class="sector-info">
                    <span>RSI: {avg_rsi:.1f}</span>
                    <span>{status}</span>
                    <span>ìƒìŠ¹: {rising_pct:.0f}%</span>
                </div>
            </div>
"""

    # GitHub ì„¤ì • í™•ì¸
    github_configured = GITHUB_USERNAME != "YOUR_GITHUB_USERNAME"

    html = f"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– {SYSTEM_TITLE}</title>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }}
        .container {{
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }}
        .header {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }}
        .header h1 {{
            font-size: 2.5em;
            margin-bottom: 10px;
        }}
        .update-info {{
            font-size: 1.2em;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: inline-block;
        }}
        .update-info .time {{
            font-weight: bold;
            font-size: 1.3em;
        }}
        .update-info .notice {{
            margin-top: 10px;
            font-size: 0.9em;
            opacity: 0.9;
        }}
        .refresh-btn {{
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }}
        .refresh-btn:hover {{
            background: #f0f0f0;
            transform: scale(1.05);
        }}
        .refresh-btn:disabled {{
            opacity: 0.6;
            cursor: not-allowed;
        }}
        #refresh-status {{
            margin-top: 15px;
            font-size: 0.9em;
            display: none;
        }}
        .content {{ padding: 40px; }}

        /* ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ì€ ë™ì¼... (ìƒëµ) */
        .section {{
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
        }}
        .section-title {{
            font-size: 1.8em;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }}
        .top8-grid {{
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }}
        @media (max-width: 1200px) {{
            .top8-grid {{ grid-template-columns: repeat(2, 1fr); }}
        }}
        @media (max-width: 768px) {{
            .top8-grid {{ grid-template-columns: 1fr; }}
        }}
        .stock-card {{
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }}
        .stock-card:hover {{
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }}
        .stock-rank {{ font-size: 2em; margin-bottom: 10px; }}
        .stock-name {{
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }}
        .stock-price {{
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }}
        .stock-change {{
            font-size: 0.9em;
            padding: 3px 10px;
            border-radius: 12px;
            display: inline-block;
        }}
        .stock-change.up {{ background: #fed7d7; color: #c53030; }}
        .stock-change.down {{ background: #bee3f8; color: #2c5282; }}
        .stock-reasons {{
            margin-top: 15px;
            font-size: 0.9em;
            color: #4a5568;
        }}
        .stock-reasons div {{
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }}
        .stock-targets {{
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e2e8f0;
        }}
        .target-item {{ text-align: center; }}
        .target-label {{
            font-size: 0.85em;
            color: #718096;
        }}
        .target-value {{
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 3px;
        }}
        .target-value.profit {{ color: #38a169; }}
        .target-value.loss {{ color: #e53e3e; }}
        .target-value.risk-low {{ color: #38a169; }}
        .target-value.risk-mid {{ color: #f59e0b; }}
        .target-value.risk-high {{ color: #e53e3e; }}
        .market-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }}
        .market-box {{
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }}
        .market-label {{
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 10px;
        }}
        .market-value {{
            font-size: 2em;
            font-weight: bold;
            color: #2d3748;
        }}
        .market-change {{
            font-size: 1.1em;
            margin-top: 5px;
        }}
        .signal-tabs {{
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }}
        .signal-tab {{
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }}
        .signal-tab.active {{
            background: #667eea;
            color: white;
        }}
        .signal-list {{
            background: white;
            border-radius: 12px;
            padding: 20px;
        }}
        .signal-item {{
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }}
        .signal-item:last-child {{ border-bottom: none; }}
        .sector-item {{
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }}
        .sector-name {{
            font-size: 1.1em;
            font-weight: bold;
            color: #2d3748;
        }}
        .sector-info {{
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– {SYSTEM_TITLE}</h1>
            <div class="update-info">
                <div class="time">ğŸ“… {update_time} ({weekday_kr.get(weekday, weekday)}) ë°ì´í„°</div>
                <div class="notice">
                    ğŸ’¡ ë§¤ì¼ í‰ì¼ ì˜¤ì „ 8ì‹œ ìë™ ì—…ë°ì´íŠ¸ (ì£¼ë§ ì œì™¸)
                </div>
            </div>
            <button class="refresh-btn" onclick="triggerRefresh()" id="refreshBtn">
                ğŸ”„ ì§€ê¸ˆ ë°”ë¡œ ìƒˆë¡œ ë¶„ì„í•˜ê¸°
            </button>
            <div id="refresh-status"></div>
        </div>
"""

    # ë‚˜ë¨¸ì§€ HTML ìƒì„± (TOP 8 ì¹´ë“œ, ì‹œì¥ ë¸Œë¦¬í•‘ ë“±)
    # ... (ì´ì „ê³¼ ë™ì¼í•œ ì½”ë“œ, ë„ˆë¬´ ê¸¸ì–´ì„œ í•µì‹¬ë§Œ í¬í•¨)

    html += """
        <div class="content">
            <div class="section">
                <div class="section-title">
                    ğŸ¯ ì˜¤ëŠ˜ì˜ TOP 8 ì¶”ì²œ ì¢…ëª©
                    <span style="font-size: 0.6em; color: #718096;">(ì €í‰ê°€ + ê³¼ë§¤ë„ + VWAP ì§€ì§€)</span>
                </div>
                <div class="top8-grid">
"""

    medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£']
    for idx, stock in enumerate(top8):
        tech = stock['tech']
        risk = stock.get('risk_level', 'ì¤‘')
        change_class = 'up' if tech['change_pct'] > 0 else 'down'
        change_sign = '+' if tech['change_pct'] > 0 else ''
        target_price = int(tech['current_price'] * 1.10)
        stop_loss = int(tech['current_price'] * 0.95)
        risk_class = 'risk-low' if risk == 'ì €' else 'risk-mid' if risk == 'ì¤‘' else 'risk-high'

        html += f"""
                    <div class="stock-card">
                        <div class="stock-rank">{medals[idx]}</div>
                        <div class="stock-name">{tech['name']}</div>
                        <div style="font-size: 0.9em; color: #718096;">({tech['code']})</div>
                        <div class="stock-price">{tech['current_price']:,}ì›</div>
                        <span class="stock-change {change_class}">{change_sign}{tech['change_pct']}%</span>
                        <div class="stock-reasons"><strong>ì¶”ì²œ ì´ìœ :</strong>
"""
        for reason in stock['reasons'][:3]:
            html += f"<div>âœ“ {reason}</div>"

        html += f"""
                        </div>
                        <div class="stock-targets">
                            <div class="target-item">
                                <div class="target-label">ëª©í‘œê°€</div>
                                <div class="target-value profit">{target_price:,}ì›</div>
                            </div>
                            <div class="target-item">
                                <div class="target-label">ì†ì ˆê°€</div>
                                <div class="target-value loss">{stop_loss:,}ì›</div>
                            </div>
                            <div class="target-item">
                                <div class="target-label">ìœ„í—˜ë„</div>
                                <div class="target-value {risk_class}">{risk}</div>
                            </div>
                        </div>
                    </div>
"""

    html += """
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.signal-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.signal-list').forEach(list => list.style.display = 'none');
            document.getElementById('tab-' + tabName).style.display = 'block';
        }

        async function triggerRefresh() {
"""

    if github_configured:
        html += f"""
            const btn = document.getElementById('refreshBtn');
            const status = document.getElementById('refresh-status');

            btn.disabled = true;
            btn.innerHTML = 'â³ GitHub Actions ì‹¤í–‰ ì¤‘...';
            status.style.display = 'block';
            status.style.color = '#667eea';
            status.innerHTML = 'ğŸš€ ë¶„ì„ ì‹œì‘! ì•½ 45ë¶„ ì†Œìš”ë©ë‹ˆë‹¤.<br>ğŸ’¡ ì´ ì°½ì„ ë‹«ì•„ë„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.';

            try {{
                const response = await fetch('https://api.github.com/repos/{GITHUB_USERNAME}/{GITHUB_REPO}/actions/workflows/final.yml/dispatches', {{
                    method: 'POST',
                    headers: {{
                        'Authorization': 'Bearer {GITHUB_TOKEN}',
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    }},
                    body: JSON.stringify({{
                        ref: 'main'
                    }})
                }});

                if (response.status === 204) {{
                    status.innerHTML = 'âœ… ë¶„ì„ ì‹œì‘ ì„±ê³µ!<br>ğŸ“Š 45ë¶„ í›„ ì´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ìµœì‹  ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ğŸ”— <a href="https://github.com/{GITHUB_USERNAME}/{GITHUB_REPO}/actions" target="_blank" style="color: white;">ì§„í–‰ ìƒí™© í™•ì¸í•˜ê¸°</a>';
                    status.style.color = '#38a169';

                    setTimeout(() => {{
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸ”„ ì§€ê¸ˆ ë°”ë¡œ ìƒˆë¡œ ë¶„ì„í•˜ê¸°';
                    }}, 5000);
                }} else {{
                    throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                }}
            }} catch (error) {{
                status.innerHTML = 'âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message + '<br>ğŸ’¡ GitHub ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';
                status.style.color = '#e53e3e';
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ ì§€ê¸ˆ ë°”ë¡œ ìƒˆë¡œ ë¶„ì„í•˜ê¸°';
            }}
"""
    else:
        html += """
            alert('âš ï¸ GitHub ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤!\\n\\n1. GitHub Personal Access Token ìƒì„±\\n2. Python ì½”ë“œì—ì„œ GITHUB_USERNAME, GITHUB_REPO, GITHUB_TOKEN ì„¤ì •\\n\\nìì„¸í•œ ë°©ë²•ì€ README íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.');
"""

    html += """
        }
    </script>
</body>
</html>
"""

    return html


def main():
    """ë©”ì¸ ì‹¤í–‰"""
    print("\n" + "="*70)
    print(f"ğŸ¤– {SYSTEM_TITLE} v3.1")
    print("="*70)

    analyzer = StockAnalyzer()

    print("\nğŸ“Š ì‹œì¥ ê°œìš” ìˆ˜ì§‘ ì¤‘...")
    market_data = get_market_overview()

    top8, golden_cross, high_volume, sector_analysis = analyzer.scan_stocks()

    if not top8:
        print("\nâŒ ì¶”ì²œ ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None

    print(f"\nâœ… TOP 8 ì¶”ì²œ:")
    for idx, stock in enumerate(top8, 1):
        risk = stock.get('risk_level', 'ì¤‘')
        print(f"  {idx}. {stock['tech']['name']} - {stock['tech']['current_price']:,}ì› (ì ìˆ˜: {stock['score']}, ìœ„í—˜ë„: {risk})")

    print("\nğŸ“ HTML ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...")
    html = generate_html(top8, golden_cross, high_volume, sector_analysis, market_data)

    output_file = 'stock_recommendation_final.html'
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(html)

    print(f"âœ… ì™„ë£Œ: {output_file}")
    print("="*70)

    try:
        from google.colab import files
        files.download(output_file)
    except:
        pass

    return output_file


if __name__ == "__main__":
    main()